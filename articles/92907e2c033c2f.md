---
title: "Godot Modding 入門"
emoji: "🐥"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["godot", "mod", "modding"]
published: false
---

## 対象者

- Godotに興味のある方
  - 構造がきれいなゲームなので、ModdingしながらGodotの勉強もできそうです
  - なおModding目的以外でのデコンパイルは禁止されています[(EULA)](https://bcnege18gifk.feishu.cn/wiki/SZA6wfp9Piz9cfkSCwScKuLRnXf)
- Moddingに興味がある方
  - 興味があれば大体解決できる！
- ある程度プログラミングができる方
  - 開発に当たり、まずゲームのプログラムを読む必要があります

## あるといい知識

- Godot, Unityに関する理解
  - Unityに似ているのでUnityの知識は流用できそうでした
- Modding経験
  - UnityのModdingフレームワークBepInExを使ったことがあると理解が早いと思います

## 対象のゲーム

ゲーム配信プラットフォームのSteamで配信されている[デスクトップ小動物牧場 - Tiny Pasture](https://store.steampowered.com/app/3167550/_/)を対象とします。

デスクトップ下に常駐して牧場で動物を育てる基本放置のんびりゲームです。
かわいい、安いので興味があれば遊んでみてください。

ゲームが提供する機能がすくなく、デコンパイルするとゲーム構造やソースコードがとても丁寧に書かれていることがわかります。
難読化もされていないのでコメントがなくても理解しやすいModdingの入門としても非常によいゲームだと思います。

## MOD配布の注意

今回対象とするゲームのMOD作成には成功しましたが、Steamワークショップにはアップロードできませんでした。
公式から提供されているSteamワークショップにMODをアップロードするツールがクラッシュして正常動作しないためです。
この問題について回避方法をご存じの方は連絡をください。私の[状況についてはこちら](https://steamcommunity.com/workshop/discussions/18446744073709551615/601904634461738790/?appid=3167550)にまとめました。

もしMODを配布する予定がある場合はアップロード先と通信できるのか事前に確認しておいた方が無難です。
MODのアップロード先はSteamワークショップ以外にもいくつかあるので他のサービスを検討してもよいと思います。

### MOD配布プラットフォーム

- [Steamワークショップ](https://steamcommunity.com/workshop/?l=japanese)
- [CurseForge - Mods & Addons Leading Community](https://legacy.curseforge.com/)
- [Nexus Mods](https://www.nexusmods.com/)
- [Thunderstore](https://thunderstore.io/)

## 成果物

この解説を通しての成果物を先に示します。

[Tiny Pasture 桁区切りMOD](https://github.com/rinjugatla/TinyPasture-separate_digits)を作成しました。
ゲームを進めるとある程度大きな数値が登場しますが、桁区切りがされていないので少し見づらいということで、これを改善するMODです。

シンプルなMODなので初めてのModdingにはよい課題だと思います。

## Modding前の注意

[Modding End User License Agreement(EULA)](https://steamcommunity.com/sharedfiles/filedetails/?id=3465376526)が示されていますので、こちらに目を通してから作業を始めてください。

### ゲームの開発環境

- ゲームエンジン
  - Godot 4.3
- 言語
  - GDScript

## Modding

### 関連フォルダパス

#### ゲームファイルフォルダ

Moddingにあたりゲームの配置先を参照する場合は以下の方法で参照できます。

1. Steamクライアントのゲーム一覧を表示
2. 対象のゲームを右クリック
3. `管理`を表示
4. `ローカルファイルを閲覧`を選択

このパスはユーザにより異なります。以下は例になります。

```text
X:\SteamLibrary\steamapps\common\TinyPasture
```

#### ゲームのSteamワークショップフォルダ

ワークショップフォルダはゲームのインストール先と紐づいています。

インストール先が以下の場合

```text
X:\SteamLibrary\steamapps\common\TinyPasture
```

ワークショップフォルダは以下になります。

```text
X:\SteamLibrary\steamapps\workshop\content\3167550
```

`3167550`はゲームのIDです。
ゲームIDが不明な場合はストアページのアドレスから確認できます。

`デスクトップ小動物牧場`の場合のストアアドレスは以下の通りです。
`https://store.steampowered.com/app/3167550/_/`

#### セーブデータフォルダ

セーブデータは以下に保存されます。
`AppData`フォルダは隠しフォルダです。
ファイルエクスプローラのアドレス欄にコピー&ペーストでアクセスする方法が簡単です。

```text
C:\Users\%username%\AppData\Roaming\TinyPasture\save
```

##### セーブデータのバックアップ

Moddingの過程などでセーブデータが破損する可能性があります。
事前にバックアップを取ることを強く推奨します。

##### Steamクラウドによるセーブデータのバックアップ

通常Steamクラウドによるバックアップが有効化されています。
この影響で、意図せずセーブデータが巻き戻されたりします。
必要に応じてSteamクラウドの利用設定を変更します。

##### Steamクラウドの設定

1. Steamクライアントのゲーム一覧を表示
2. 対象のゲームを右クリック
3. `プロパティ`を表示
4. `一般タブ`を表示(最初に表示されるタブ)
5. `Steamクラウドに[ゲーム名]のセーブデータを保存`のトグルを変更

### 環境構築

作業環境にはマルチバイト文字が含まれないパスが安全だと思います。
(マルチバイトパスの検証はしていません)

#### ゲームのデコンパイル

##### デコンパイルツールの導入

[Godotのデコンパイルツール](https://github.com/GDRETools/gdsdecomp/releases)をダウンロードします。
[先人の知恵](https://steamcommunity.com/sharedfiles/filedetails/?id=3465376526)でv0.9.0-beta.4を推奨していますが、v0.9.1でも問題なくデコンパイルできました。

私はv0.9.1を利用しました。

ダウンロードしたzipファイルを任意の位置に展開します。

##### デコンパイル

`gdre_tools.exe`を実行します。

ゲームインストール先の`TinyPasture.pck`を`Godot RE Tools`にドラッグ&ドロップします。

すべての項目にチェックされていることを確認し、出力先のパスを指定して`Extract`します。

![gdre_tools出力設定](/images//92907e2c033c2f/gdre_tools-extract-setting.png)

ツールを閉じます。

#### Godot Steamプラグインの導入

[GodotSteam](https://github.com/GodotSteam/GodotSteam/releases)をダウンロードします。
ゲームのバージョンに合う物をダウンロードしてください。
Godotのバージョンがわからない場合は`gdre_tools`でデコンパイル画面で確認できます。
`デスクトップ小動物牧場`の場合はGodot4.3を利用しているので、[Godot 4.1-4.4 - Steamworks 1.61 - GodotSteam GDExtension 4.13](https://github.com/GodotSteam/GodotSteam/releases/tag/v4.14-gde)の`godotsteam-4.14-gdextension-plugin-4.1-4.3.zip`をダウンロードします。

ダウンロードしたzipファイルを任意の位置に展開します。

zipファイル内の`addon`フォルダに含まれる`godotsteam`フォルダをデコンパイル済みのゲームフォルダ`addon`にコピーし上書きします。

![Godot steam addonの導入](/images/92907e2c033c2f/godot-steam-addon.png)

#### Godotによるゲームの読み込み

##### Godotの導入

Godot4.3を利用して作られているので、Godot公式サイトから[4.3-stable](https://godotengine.org/download/archive/4.3-stable/)を入手します。
私はWindows - Standardを入手しました。

ダウンロードしたzipファイルを任意の位置に展開します。

##### ゲームの読み込み

`Godot_v4.3-stable_win64.exe`を実行し、Godotを起動します。

`インポート`ボタンからデコンパイルしたゲームフォルダを選択、インポートして編集から読み込みを開始します。

![alt text](/images/92907e2c033c2f/godot-select-game.png)

読み込み時に警告ポップアップが表示されることがありますが無視します。
Godot起動後にファイルの読み込みが入るのでしばらく待ちます。

##### ModLoaderの有効化

1. 上部メニューから`プロジェクト`メニューを表示
2. `プロジェクト設定`を選択
3. `プラグイン`タブ表示
4. `mod loader`を有効化
5. 設定画面を閉じる

![ModLoaderの有効化](/images/92907e2c033c2f/godot-enable-mod-loader.png)

### MODの作成

#### MODの新規作成

画面上部の`Mod Tool`を選択し、`Create new Mod`を選択します。
`Namespace`と`Mod Name`を記入し作成します。

| 項目名                        | 必須か | 説明                         | 備考                                       |
| ----------------------------- | ------ | ---------------------------- | ------------------------------------------ |
| Mod Name                      | 〇     | MOD名                        | 半角英数が無難、アンダースコアは使用できる |
| NameSpace                     | 〇     | 団体名や作者名               | 半角英数が無難、アンダースコアは使用できる |

`Namespace`と`Mod Name`は**MODのフォルダ名に使用されます。**
後でも変更できますが、ややこしいので最初に決めておく方が良いです。

長すぎる名前をつけるとMODが読み込まれない場合があるのである程度の長さにとどめておくとよいです。
50文字くらいの長さのMODを作ったところ、読み込めませんでした。
※試行錯誤していたので、MODの問題ではなかった可能性もあります。

![MODの新規作成](/images//92907e2c033c2f/godot-create-new-mod.png)

#### 既存のMOD情報を編集

画面上部の`Mod Tool`を選択し、`Connect existing Mod`から編集対象のMODを選択します。

![既存のMODの選択](/images/92907e2c033c2f/godot-select-exist-mod.png)

MODの基本情報を編集出来ます。ここでは最低限の解説とします。

| 項目名                        | 必須か | 説明                         | 備考                                       |
| ----------------------------- | ------ | ---------------------------- | ------------------------------------------ |
| Mod Name                      | 〇     | MOD名                        | 半角英数が無難、アンダースコアは使用できる |
| NameSpace                     | 〇     | 団体名や作者名               | 半角英数が無難、アンダースコアは使用できる |
| Compatible Game Version       |        | 対応するゲームバージョン     | 今回は`1.0.10`                             |
| Compatible Mod Loader Version |        | 対応するMod Loaderバージョン | 今回は`7.0.1`                              |

**設定を変更した場合は必ず画面右上の`Save to manifest.json`を実行します。**
`Ctrl + S`では保存されません。

![MOD情報の設定](/images/92907e2c033c2f/godot-mod-setting.png)

#### MODの保存先

開発中のMODはデコンパイルしたゲームと同じフォルダに格納されます。
MODのファイルは全て`mods-unpacked`フォルダに`NameSpace-ModName`の書式のフォルダに格納されます。
このフォルダ名の書式はとても重要です。
この書式を守らないとModLoaderに認識されず、正常にMODが読み込まれません。

```text
デコンパイルされたゲームフォルダ
├─mods-unpacked // 開発中のMODが格納されるフォルダ
│  │  
│  ├─rin_jugatla-separate_digits // NameSpace-ModNameの書式
│  │  │  manifest.json // MODの基本情報 先ほどのGUIで設定した項目が保存される
│  │  │  mod_main.gd // MODのエントリーポイント
```

## 参考資料

- [MOD制作及上传指南-MOD Creation and Upload Guide](https://steamcommunity.com/sharedfiles/filedetails/?id=3465376526)
  - おそらく公式または公式に近い方からのガイド
  - 内容はModding環境の構築から新しい動物の追加方法、MODのSteamワークショップへの公開方法
  - feishuに公開されているガイドはブラウザのウェブページ丸ごとの翻訳が機能しなかったので読むのが少し大変
- [Godot Mod Loader](https://wiki.godotmodding.com/)
  - 使用するModLoaderの公式ドキュメント
- [Brotato Modding Guide 【環境構築】](https://qiita.com/makizakao/items/fca7a550b8090dbc860f)
  - 別のゲームですが、Godot環境でのModdingを扱った記事

## 関連ツール

- [Godot](https://godotengine.org/)
  - ゲームエンジン公式サイト
- [godot-mod-loader](https://github.com/GodotModding/godot-mod-loader/)
  - Godot向けModLoader
- [GodotSteam](https://github.com/GodotSteam/GodotSteam)
  - Godot EngineとSteam向けツールのエコシステム
- [gdsdecomp](https://github.com/GDRETools/gdsdecomp)
  - Godotのデコンパイルツール
